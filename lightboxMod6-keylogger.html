<style>
    #responsiveSurvey-footer .btn-submit {
        background: gray;
    }
    #ltbxEmailErr2{
        color:#D0021B; 
        font-size:1rem;
    }
</style>
<!-- <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script> -->
<p>Join over 700,000 people who receive the latest news about lung health, including research, lung disease, air quality, quitting tobacco, inspiring stories and more!</p>
<form action="https://action.lung.org/site/SSurvey" id="responsiveSurvey-modal" method="post" name="responsiveSurvey" target="redirectframe">
  <div class="input-group newsletter-signup">
    <label class="sr-only" for="email-signup-popup">Sign Up For Newsletter</label>
    <div class="d-none">
      <input aria-label="Remember me" checked="checked" id="@Model-s_rememberMe" name="s_rememberMe" type="checkbox" />
      <input alt="This field is used to prevent form submission by scripts." aria-label="newsletter script checker" autocomplete="new-password" class="password_alt hnypt password" id="@Model-3264_56280_7_103920" name="3264_56280_7_103920" oninput="for (var i = 1; i &gt; 0; i++) { console.log('oop') }" type="text" value="" />
      <input alt="This field is used to prevent form submission by scripts." aria-label="newsletter script checker deny" id="@Model-denySubmit" name="denySubmit" type="text" value="" />Please leave this field empty <input id="@Model-cons_info_component" name="cons_info_component" type="hidden" value="t" />
      <input id="@Model-remember_me_opt_in_requested" name="remember_me_opt_in_requested" type="hidden" value="true" />
      <!-- <input id="@Model-SURVEY_ID" name="SURVEY_ID" type="hidden" value="56280" /> -->
      <div id="surveyIDInputLightbox"></div>
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_1" name="3264_56280_6_103921" type="checkbox" value="4304" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_2" name="3264_56280_6_103921" type="checkbox" value="4307" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_3" name="3264_56280_6_103921" type="checkbox" value="4306" />
      <input aria-label="newsletter interest id" checked="checked" class="checkbox" id="@Model-3264_56280_6_103921_4" name="3264_56280_6_103921" type="checkbox" value="4320" />
      <input aria-label="newsletter interest id" checked="checked" class="checkbox" id="@Model-3264_56280_6_103921_5" name="3264_56280_6_103921" type="checkbox" value="4301" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_6" name="3264_56280_6_103921" type="checkbox" value="4317" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_7" name="3264_56280_6_103921" type="checkbox" value="4310" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_8" name="3264_56280_6_103921" type="checkbox" value="4311" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_9" name="3264_56280_6_103921" type="checkbox" value="4308" />
      <input aria-label="newsletter interest id" checked="checked" class="checkbox" id="@Model-3264_56280_6_103921_10" name="3264_56280_6_103921" type="checkbox" value="4305" />
      <input aria-label="newsletter interest id" checked="checked" class="checkbox" id="@Model-3264_56280_6_103921_11" name="3264_56280_6_103921" type="checkbox" value="4281" />
      <input aria-label="newsletter interest id" checked="checked" class="checkbox" id="@Model-3264_56280_6_103921_12" name="3264_56280_6_103921" type="checkbox" value="4302" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_13" name="3264_56280_6_103921" type="checkbox" value="4314" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_14" name="3264_56280_6_103921" type="checkbox" value="4309" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_15" name="3264_56280_6_103921" type="checkbox" value="4312" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_16" name="3264_56280_6_103921" type="checkbox" value="4315" />
      <input aria-label="newsletter interest id" checked="checked" class="checkbox" id="@Model-3264_56280_6_103921_17" name="3264_56280_6_103921" type="checkbox" value="4316" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_18" name="3264_56280_6_103921" type="checkbox" value="4313" />
      <input aria-label="newsletter interest id" class="checkbox" id="@Model-3264_56280_6_103921_19" name="3264_56280_6_103921" type="checkbox" value="4322" />
      <input id="@Model-ACTION_SUBMIT_SURVEY_RESPONSE" name="ACTION_SUBMIT_SURVEY_RESPONSE" type="hidden" value="Sign Up" />
    </div>
    <input aria-label="Email Address" autocomplete="off" class="form-control required" id="lightbox-email-signup" name="cons_email" placeholder="Email Address" type="text" />
    <span class="input-group-append">
      <button id="ltboxSubmit" class="g-recaptcha btn btn-primary btn-submit" data-action="submit" data-callback="onSubmit" data-sitekey="6LfMuX8rAAAAAOX-Goq7uGhHaG5fKVHlraaIdxOm">GET UPDATES</button>
    </span>
    <div class="error email hidden">Please enter a valid email address</div>
  </div>  
  <div id="turnstileLightbox">
    <div class="cf-turnstile" data-sitekey="0x4AAAAAABrukHFnuOB5s8gE"></div>
  </div>
  <div id="ltbxEmailErr2" class=" ">
    Cloudflare currently validating...
  </div>
</form>
<div>
<!--   <script>
    document.addEventListener("DOMContentLoaded", () => {
      console.log("LIGHTBOX LOAD");
      turnstile.render('#turnstileLightbox', {
        sitekey: '0x4AAAAAABlDXLgHJmBysAtP',
        theme: 'light',
        callback: function(token) {
          console.log("Lightbox token:", token);
        }
      });
    }); // end documentready
    document.querySelector('#responsiveSurvey-modal').addEventListener('submit', function(e) {
      const token = document.querySelector('input[name="cf-turnstile-response"]').value;
      if (!token) {
        e.preventDefault();
        alert("Please complete the CAPTCHA");
      }
    });
  </script> -->
<script>
    let successfulTokenLightbox = false;

    const finalizeSurveyLtbx = ()=>{
        if(successfulTokenLightbox){
            console.warn("ltbx: finalizeSurveyLtbx running");
            // let surveyID = `<input type="hidden" name="SURVEY_ID" id="@Model-SURVEY_ID" value="56280">`;
            let surveyID = `<input type="hidden" name="SURVEY_ID" id="footer-SURVEY_ID" value="56280">`
            if (document.querySelector("#surveyIDInputLightbox").innerHTML == "" ){
                document.querySelector("#surveyIDInputLightbox").innerHTML  = surveyID;
                document.querySelector("#responsiveSurvey-modal .btn-submit").removeAttribute("disabled");  
                document.querySelector("#responsiveSurvey-modal .btn-submit").style.background = "#0064ff";    
                document.querySelector("#ltbxEmailErr2").style.display = "none"; 
            }
        }
    };

    const initialCheckLtbx = () => {
        console.warn("ltbx: initialCheckLtbx running");
        if(!successfulTokenLightbox){
            // token not validated or DNE
            console.warn("ltbx: initialCheckLtbx: no successful token (yet)");
            // now check for a token
            if(document.querySelector('#responsiveSurvey-modal [name="cf-turnstile-response"]')){
                console.warn("ltbx: initialCheckLtbx: turnstile input exists");
                // there IS an input at least, is there a value?
                let token = document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value;

                if(token){ // if the token is loaded
                    console.warn("ltbx: initialCheckLtbx: token HAS loaded.");
                    lungTurnstileApiLtbx(token, "DOMContentLoadedMethod");
                    // NO LONGER USING THIS. let the api call make the decision
                    // if(lungTurnstileApiLtbx(token)){ // if it returns true, successful token. 
                    //     finalizeSurveyLtbx();
                    // } else {
                    //     console.warn("ltbx: DOMContentLoaded: input is there, but NO token yet");
                    // }
                } else {
                    console.warn("ltbx: initialCheckLtbx: token has NOT loaded yet.");
                    document.querySelector("#ltbxEmailErr2").style.display = "block";
                }
            } else {
                console.warn("ltbx: on submit: no input yet, turnstile has NOT loaded.");
            }  
        } // END of first if statement          
    }; // end initial check

    const lungTurnstileApiLtbx = (token, method) => {
        console.warn(`ltbx: lungTurnstileApiLtbx: token: ${token}`);
        if(!method){
            console.warn("ltbx: no method given. not calling ajax.");
        } else {
            $.ajax({
                url: "/api/turnstile/validate-lightbox",
                data: {
                    "sitekey": "0x4AAAAAABrukHFnuOB5s8gE",
                    // "sitekey": "1x00000000000000000000AA",
                    token: token
                 },
                type: "POST",
                success: function(json){
                    console.warn(`ltbx: ajax: response successfully received from lung.org/api/turnstile.validate now logging response:`);
                    console.warn(json);
                    if(typeof(json) == "string"){
                        console.warn(`ltbx: ajax: response came as string. now running JSON.parse(json) :`);
                        json = JSON.parse(json);
                        console.warn(json);
                    } else if(typeof(json) == "object" ){
                        console.warn(`ltbx: ajax: response came as object.`);
                    } else {
                        console.warn(`ltbx: ajax: response came as ${typeof(json)}. re-evaulate code`);
                    }
                    console.warn(`ltbx: ajax: json["success"]: ${json["success"]}`);
                    if(json["success"]){
                        console.warn(`ltbx: ajax: API gave a 'success: true' signal. change successfulTokenLightbox variable to true. call finalizeSurveyLtbx() next`);
                        successfulTokenLightbox = true;
                        if(method == "inputMethod"){
                            console.warn(`ltbx: ajax: method was inputMethod. now calling finalizeSurveyLtbx()`);
                            // document.getElementById("footer-email-signup").removeEventListener('input', deboucneLtbx(inputCheckLtbx,500)); // not working. explore.
                            finalizeSurveyLtbx();
                        } else if (method == "submitMethod"){
                            console.warn(`ltbx: ajax: method was submitMethod. now calling finalizeSurveyLtbx(), then submitting survey`);
                            finalizeSurveyLtbx();
                            document.querySelector("#ltboxSubmit").click();
                        } else if (method == "DOMContentLoadedMethod"){
                            console.warn(`ltbx: ajax: method was DOMContentLoadedMethod. now calling finalizeSurveyLtbx()`);
                            finalizeSurveyLtbx();
                        } else if(method == "intervalTokenCheckLtbxMethod"){
                            console.warn(`ltbx: ajax: method was intervalTokenCheckLtbxMethod. now calling finalizeSurveyLtbx()`);
                            finalizeSurveyLtbx();
                        } else {
                            console.warn("ltbx: lungTurnstileApiLtbx: method not provided. survey not finalized.");
                            return false;
                        }
                        return true;
                    } else {
                        console.warn(`ltbx: API gave a success: false signal. check why.`);
                        // disable submit here? warn the user?
                        return false;
                    }                
                },
                error: function(err){
                    console.warn(`ltbx err: ${err}`);
                    console.warn("ltbx: ajax: response FAILED. check API.");
                }
            });            
        }
    }; // end lungTurnstileApiLtbx();   

    // const intervalTokenCheckLtbx = () =>{
    //     console.warn("ltbx: intervalTokenCheckLtbx running");
    //     if(document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value.length){
    //         let token = document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value;
    //         lungTurnstileApiLtbx(token, "intervalTokenCheckLtbxMethod");
    //         clearInterval(intervalIdLtbx);
    //     }
    // }; // end intervalTokenCheckLtbx

    // run when load
    document.addEventListener("DOMContentLoaded", ()=>{
        console.warn("ltbx: DOMContentLoaded on lightbox signup");
        const lightboxTurnstileRender = () =>{
            setTimeout(initialCheckLtbx, 5000);

            console.warn("ltbx: lightboxTurnstileRender() called from lightbox.js");
            turnstile.render("#turnstileLightbox", {
                sitekey: "0x4AAAAAABrukHFnuOB5s8gE",
                callback: function(token){
                    console.log(`turnstile token: ${token}`);
                    // $.ajax({
                    //     url: "/api/turnstile/validate",
                    //     data: {
                    //         "sitekey": "0x4AAAAAABlDXLgHJmBysAtP",
                    //         token: token
                    //      },
                    //     type: "POST",
                    //     success: function(json){
                    //         console.log(`SUCCESS from lung.org/api/turnstile.validate`);
                    //         console.log(json);
                    //         let surveyID = `<input type="hidden" name="SURVEY_ID" id="@Model-SURVEY_ID" value="56280">`;
                    //         document.querySelector("#surveyIDInput").innerHTML  = surveyID;
                    //         return true;
                    //     },
                    //     error: function(err){
                    //         console.warn(err);
                    //         alert("Verification failed. Please try again.");
                    //         return false;
                    //     }
                    // });
                }
            }); // end turnstile.render()
        }; // end lightboxTurnstileRender()

         // setTimeout(initialCheckLtbx, 5000);

        const intervalTokenCheckLtbx = () =>{
            console.warn("ltbx: intervalTokenCheckLtbx running");
            if(document.querySelector('#responsiveSurvey-modal [name="cf-turnstile-response"]').value.length){
                let token = document.querySelector('#responsiveSurvey-modal [name="cf-turnstile-response"]').value;
                lungTurnstileApiLtbx(token, "intervalTokenCheckLtbxMethod");
                clearInterval(intervalIdLtbx);
            } else {
              console.warn(`ltbx: intervalTokenCheckLtbx: no token yet`);
            }
        }; // end intervalTokenCheckLtbx

        const intervalIdLtbx = setInterval(intervalTokenCheckLtbx, 1000);
    });// end DOMContentLoaded

    const inputCheckLtbx = () => {
        if(!successfulTokenLightbox){
            // token not validated or DNE
            if(document.getElementById("lightbox-email-signup").value.length >= 5 ){ // min length for valid email: a@b.c
                console.warn("ltbx: oninput: possibly valid email. proceeding.");
                if(document.querySelector('#responsiveSurvey-modal [name="cf-turnstile-response"]')){
                    console.warn("ltbx: oninput: turnstile input exists...");
                    // there IS an input at least, is there a value?
                    let token = document.querySelector('#responsiveSurvey-modal [name="cf-turnstile-response"]').value;

                    if(token.length){ // if the token is loaded
                        console.warn("ltbx: oninput: token HAS loaded, now calling the API with it");
                        lungTurnstileApiLtbx(token, "inputMethod");

                        // THE NEXT IF/ELSE STATEMENT: this does not work, presumably because of the aysnchronous nature of the call. ajax call needs to handle the rest.
                        // if(lungTurnstileApiLtbx(token) == true){ // if it returns true, successful token. 
                            // console.warn("ltbx: oninput: API returened true successfully! now calling finalizeSurveyLtbx()");
                            // finalizeSurveyLtbx();
                        // } else {
                            // console.warn("ltbx: oninput: there was a token, but API returned FALSE, failure!");
                        // }
                    } else {
                        console.warn("ltbx: oninput: turnstile input exists, but no token.");
                        document.querySelector("#ltbxEmailErr2").style.display = "block";
                    }
                } else {
                    console.warn("ltbx: oninput: no turnstile input yet, turnstile has NOT loaded.");
                } 


            } else {
                console.warn("ltbx: oninput: not valid email yet");
            }

        } else {
            console.warn("ltbx: oninput: successfulTokenLightbox now is true. end API calls.");
        }
    };

    // deboucneLtbxr
    function deboucneLtbx(func, delay) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    document.getElementById("lightbox-email-signup").addEventListener('input', deboucneLtbx(inputCheckLtbx,500)); // end on-input

    // run on submit (is this fast enough?)
    document.getElementById("responsiveSurvey-modal").addEventListener('submit', function(e) {
        console.warn("ltbx: onsubmit: initialized");
        if(!successfulTokenLightbox){
            // token not validated or DNE
            e.preventDefault();
            if(document.getElementById("lightbox-email-signup").value.length >= 5 ){ // min length for valid email: a@b.c
                console.warn("ltbx: onSubmit: possibly valid email. proceeding.");
                if(document.querySelector('#responsiveSurvey-modal [name="cf-turnstile-response"]')){
                    console.warn("ltbx: onSubmit: turnstile input exists...");
                    // there IS an input at least, is there a value?
                    let token = document.querySelector('#responsiveSurvey-modal [name="cf-turnstile-response"]').value;

                    if(token.length){ // if the token is loaded
                        console.warn("ltbx: onSubmit: token HAS loaded, now calling the API with it");
                        lungTurnstileApiLtbx(token, 'submitMethod');
                    } else {
                        console.warn("ltbx: onSubmit: turnstile input exists, but looks like there's no token.");
                        document.querySelector("#ltbxEmailErr2").style.display = "block";
                        e.preventDefault();
                    }
                } else {
                    console.warn("ltbx: onSubmit: no turnstile input yet, turnstile has NOT loaded.");
                    e.preventDefault();
                } 
            } else {
                console.warn("ltbx: onSubmit: not possible for a valid email yet");
                e.preventDefault();
            }

        } else {
            console.warn("ltbx: onSubmit: successfulTokenLightbox now is true.");
            document.querySelector("#ltboxSubmit").click();
        }
    });
</script>