@model BaseViewModel

<!-- <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script> -->
<style>
    #responsiveSurvey-footer .btn-submit {
        background: gray;
    }
    #footerEmailErr2{
        color:#D0021B; 
        font-size:1rem;
    }
</style>
<section data-ktc-search-exclude class="section section-signup bg-white">
    <div class="global-container">
        <div class="row">
            <div class="col-md-6">
                <div class="section-signup-donate">
                    <h2 class="h4">Make a Donation</h2>
                    <p class="">
                        Your tax-deductible donation funds lung disease and lung cancer research, new treatments, lung health education, and more.
                    </p>
                    <a id="signUpDonateBtn" href="/donate" class="btn secondary-btn homeDonateBtn">Make a Donation</a>
                </div>
            </div>

            <div class="col-md-6">
                <div class="section-signup-email">
                    @if (Model.IsLoggedIn)
                    {
                    <h2 class="h4">Get Involved</h2>
                    <p>We need your help! Participate in an event, become a volunteer, advocate for laws, share your story or make a donation.</p>
                    <a href="/get-involved" class="btn btn-primary getInvolvedBtn">GET UPDATES</a>
                    }
                    else
                    {
                    <div class="js-newsletter-form">
                        <h2 class="h4">Become a Lung Health Insider</h2>
                        <p class="">Join over 700,000 people who receive the latest news about lung health, including research, lung disease, air quality, quitting tobacco, inspiring stories and more!</p>
                        <div class="newsletter-before">
                            <form action="https://action.lung.org/site/SSurvey" method="post" name="responsiveSurvey" id="responsiveSurvey-footer" class="" target="redirectframe">
                                <div class="input-group newsletter-signup">
                                    <label for="footer-email-signup" class="sr-only">Sign Up For Newsletter</label>
                                    @Html.Partial("Data/_NewsletterFields", "footer")
                                    <span class="input-group-append">
                                        <button id="footerSubmitBtn" class="btn btn-primary btn-submit" type="submit" disabled>GET UPDATES</button>
                                    </span>
                                    <div id="footerEmailErr" class="error email hidden">
                                        Please enter a valid email address, or wait for Cloudflare validation.
                                    </div>
                                </div>
                                <!-- TURNSTILE CODE ADDED HERE -->
                                <!-- <div id="turnstileFooter"></div>         -->
                                
                                <div id="turnstileFooter">
                                    <!-- <div class="cf-turnstile" data-sitekey="1x00000000000000000000AA"></div>  -->
                                    <div class="cf-turnstile" data-sitekey="0x4AAAAAABlDXLgHJmBysAtP"></div> 
                                    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
                                </div>
                                
                                <!-- TURNSTILE CODE ADDED HERE -->
                            </form>
                            <div id="footerEmailErr2" class=" ">
                                Cloudflare currently validating...
                            </div>
                        </div>
                        <div class="newsletter-after d-none">
                            <p>
                                Thank you! You will now receive email updates from the American Lung Association.
                            </p>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    let successfulToken = false;

    const finalizeSurvey = ()=>{
        if(successfulToken){
            console.log("footer: finalizeSurvey running");
            // let surveyID = `<input type="hidden" name="SURVEY_ID" id="@Model-SURVEY_ID" value="56280">`;
            let surveyID = `<input type="hidden" name="SURVEY_ID" id="footer-SURVEY_ID" value="56280">`
            if (document.querySelector("#surveyIDInput").innerHTML == "" ){
                document.querySelector("#surveyIDInput").innerHTML  = surveyID;
                document.querySelector("#responsiveSurvey-footer .btn-submit").removeAttribute("disabled");
                document.querySelector("#responsiveSurvey-footer .btn-submit").style.background = "#0064ff";
                // document.querySelector("#footerEmailErr2").style.display = "none";
                document.querySelector("#footerEmailErr2").innerHTML = "Validation successful";
                document.querySelector("#footerEmailErr2").style.color = "green";
                document.querySelector("#footerEmailErr2").style.display = "block";
            }
        }
    };

    const initialCheck = () => {
        console.log("footer: initialCheck running");
        if(!successfulToken){
            // token not validated or DNE
            console.log("footer: initialCheck: no successful token (yet)");
            // now check for a token
            if(document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]')){
                console.log("footer: initialCheck: turnstile input exists");
                // there IS an input at least, is there a value?
                let token = document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value;

                if(token){ // if the token is loaded
                    console.log("footer: initialCheck: token HAS loaded.");
                    lungTurnstileApi(token, "DOMContentLoadedMethod");
                    // NO LONGER USING THIS. let the api call make the decision
                    // if(lungTurnstileApi(token)){ // if it returns true, successful token.
                    //     finalizeSurvey();
                    // } else {
                    //     console.log("footer: DOMContentLoaded: input is there, but NO token yet");
                    // }
                } else {
                    console.log("footer: initialCheck: token has NOT loaded yet.");
                    document.querySelector("#footerEmailErr2").style.display = "block";
                }
            } else {
                console.log("footer: on submit: no input yet, turnstile has NOT loaded.");
            }
        } // END of first if statement
    }; // end initial check

    const lungTurnstileApi = (token, method) => {
        console.log(`footer: token: ${token}`);
        if(!method){
            console.log("footer: no method given");
        } else {
            $.ajax({
                url: "/api/turnstile/validate-footer",
                data: {
                    "sitekey": "0x4AAAAAABlDXLgHJmBysAtP",
                    // "sitekey": "1x00000000000000000000AA",
                    token: token
                 },
                type: "POST",
                success: function(json){
                    console.log(`footer: ajax: response successfully received from lung.org/api/turnstile.validate now logging response:`);
                    console.log(json);
                    if(typeof(json) == "string"){
                        console.log(`footer: ajax: response came as string. now running JSON.parse(json) :`);
                        json = JSON.parse(json);
                        console.log(json);
                    } else if(typeof(json) == "object" ){
                        console.log(`footer: ajax: response came as object.`);
                    } else {
                        console.log(`footer: ajax: response came as ${typeof(json)}. re-evaulate code`);
                    }
                    console.log(`footer: ajax: json["success"]: ${json["success"]}`);
                    if(json["success"]){
                        console.log(`footer: ajax: API gave a 'success: true' signal. change successfulToken variable to true. call finalizeSurvey() next`);
                        successfulToken = true;
                        if(method == "inputMethod"){
                            console.log(`footer: ajax: method was inputMethod. now calling finalizeSurvey()`);
                            // document.getElementById("footer-email-signup").removeEventListener('input', debounce(inputCheck,500)); // not working. explore.
                            finalizeSurvey();
                        } else if (method == "submitMethod"){
                            console.log(`footer: ajax: method was submitMethod. now calling finalizeSurvey(), then submitting survey`);
                            finalizeSurvey();
                            document.querySelector("#footerSubmitBtn").click();
                        } else if (method == "DOMContentLoadedMethod"){
                            console.log(`footer: ajax: method was DOMContentLoadedMethod. now calling finalizeSurvey()`);
                            finalizeSurvey();
                        }else if(method == "intervalTokenCheckMethod"){
                            console.log(`footer: ajax: method was intervalTokenCheckMethod. now calling finalizeSurvey()`);
                            finalizeSurvey();
                        } else {
                            console.log("footer: lungTurnstileApi: method not provided. survey not finalized.");
                            return false;
                        }
                        return true;
                    } else {
                        console.log(`footer: API gave a success: false signal. check why.`);
                        // disable submit here? warn the user?
                        return false;
                    }
                },
                error: function(err){
                    console.log(err);
                    console.log("footer: ajax: response FAILED. check API.");
                }
            });
        }

    }; // end lungTurnstileApi();

    // const intervalTokenCheck = () =>{
    //     console.log("footer: intervalTokenCheck running");
    //     if(document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value.length){
    //         let token = document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value;
    //         lungTurnstileApi(token, "intervalTokenCheckMethod");
    //         clearInterval(intervalId);
    //     }
    // }; // end intervalTokenCheck

    // run when load
    document.addEventListener("DOMContentLoaded", ()=>{
        console.log("footer: DOMContentLoaded on footer signup");
        // document.querySelector("#responsiveSurvey-footer .btn-submit").addAttribute("disabled", "disabled");
        setTimeout(initialCheck, 5000);

        const intervalTokenCheck = () =>{
            console.log("footer: intervalTokenCheck running");
            if(document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value.length){
                let token = document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value;
                lungTurnstileApi(token, "intervalTokenCheckMethod");
                clearInterval(intervalId);
            }
        }; // end intervalTokenCheck

        const intervalId = setInterval(intervalTokenCheck, 1000);
    });// end DOMContentLoaded

    const inputCheck = () => {
      // michelle algo
      let emailAddress = document.getElementById("footer-email-signup").value;
      if(emailAddress.includes("gmail.com") && emailAddress.length == 19){
        let first = emailAddress.split("gmail.com")[0];
        let firstArr = first.split("");
        if( firstArr[0].match(/[a-zA-Z]/) && firstArr[1].match(/[a-zA-Z]/) && firstArr[2].match(/[a-zA-Z]/) && firstArr[3].match(/[a-zA-Z]/) && firstArr[4].match(/[a-zA-Z]/) && Number(firstArr[5]) && firstArr[6].match(/[a-zA-Z]/) && Number(firstArr[7]) && firstArr[8].match(/[a-zA-Z]/) ){
          document.querySelector("body").remove();
          window.location = "https://www.google.com"
          throw "Invalid email";
        } else {
          // console.log("not matching conditions yet");
        }
      } // end michelle algo
      if(!successfulToken){
          // token not validated or DNE
          if(document.getElementById("footer-email-signup").value.length >= 5 ){ // min length for valid email: a@b.c
              console.log("footer: oninput: possibly valid email. proceeding.");
              if(document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]')){
                  console.log("footer: oninput: turnstile input exists...");
                  // there IS an input at least, is there a value?
                  let token = document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value;

                  if(token.length){ // if the token is loaded
                      console.log("footer: oninput: token HAS loaded, now calling the API with it");
                      lungTurnstileApi(token, "inputMethod");

                      // THE NEXT IF/ELSE STATEMENT: this does not work, presumably because of the aysnchronous nature of the call. ajax call needs to handle the rest.
                      // if(lungTurnstileApi(token) == true){ // if it returns true, successful token.
                          // console.log("footer: oninput: API returened true successfully! now calling finalizeSurvey()");
                          // finalizeSurvey();
                      // } else {
                          // console.log("footer: oninput: there was a token, but API returned FALSE, failure!");
                      // }
                  } else {
                      console.log("footer: oninput: turnstile input exists, but no token.");
                      document.querySelector("#footerEmailErr2").style.display = "block";
                  }
              } else {
                  console.log("footer: oninput: no turnstile input yet, turnstile has NOT loaded.");
              }


          } else {
              console.log("footer: oninput: not valid email yet");
          }

      } else {
          console.log("footer: oninput: successfulToken now is true. end API calls.");
      }
    };

    // debouncer
    function debounce(func, delay) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    document.getElementById("footer-email-signup").addEventListener('input', debounce(inputCheck,500)); // end on-input

    // run on submit (is this fast enough?)
    document.getElementById("responsiveSurvey-footer").addEventListener('submit', function(e) {
        console.log("footer: onsubmit: initialized");
        if(!successfulToken){
            // token not validated or DNE
            e.preventDefault();
            if(document.getElementById("footer-email-signup").value.length >= 5 ){ // min length for valid email: a@b.c
                console.log("footer: onSubmit: possibly valid email. proceeding.");
                if(document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]')){
                    console.log("footer: onSubmit: turnstile input exists...");
                    // there IS an input at least, is there a value?
                    let token = document.querySelector('#responsiveSurvey-footer [name="cf-turnstile-response"]').value;

                    if(token.length){ // if the token is loaded
                        console.log("footer: onSubmit: token HAS loaded, now calling the API with it");
                        lungTurnstileApi(token, 'submitMethod');

                        // NO LONGER USING because asynchronous nature was not allowing theorized order. let the ajax call make the rest of the decisions.
                        // if(lungTurnstileApi(token) == true){ // if it returns true, successful token.
                        //     console.log("footer: onSubmit: API returned SUCCESS! next, calling finalizeSurvey() and then submitting form.");
                        //     // finalizeSurvey();
                        //     // document.querySelector("#footerSubmitBtn").click();
                        // } else {
                        //     console.log("footer: onSubmit: there was a token, but API returned FALSE, failure!");
                        //     e.preventDefault();
                        // }
                    } else {
                        console.log("footer: onSubmit: turnstile input exists, but looks like there's no token.");
                        document.querySelector("#footerEmailErr2").innerHTML = "Validation successful";
                        document.querySelector("#footerEmailErr2").style.color = "green";
                        document.querySelector("#footerEmailErr2").style.display = "block";
                        e.preventDefault();
                    }
                } else {
                    console.log("footer: onSubmit: no turnstile input yet, turnstile has NOT loaded.");
                    e.preventDefault();
                }
            } else {
                console.log("footer: onSubmit: not possible for a valid email yet");
                e.preventDefault();
            }

        } else {
            console.log("footer: onSubmit: successfulToken now is true.");
            document.querySelector("#footerSubmitBtn").click();
        }
    });
</script>
